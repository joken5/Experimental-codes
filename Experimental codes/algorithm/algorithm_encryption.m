clc;
clear;
format long;
I=imread('Lena512.bmp');
I1=I(:,:,1);I2=I(:,:,2);I3=I(:,:,3);
[M,N]=size(I1);
I=[I1,I2,I3];
x1=zeros(1,2*M*N+2*M);
y1=zeros(1,2*M*N+2*M);
z1=zeros(1,2*M*N+2*M);
%x1(1)=rand;y1(1)=rand; z1(1)=rand;
x1(1)=0.17283865370934;y1(1)=0.78273617271432; z1(1)=0.39098163748756;
k=9;
r=6;
for i=2:501
        x1(i)=mod((2^(k+x1(i-1))).*r.*((y1(i-1)^2)+z1(i-1)),1);
        y1(i)=mod((3^(k+y1(i-1))).*r.*((z1(i-1)^2)+x1(i-1)),1);
        z1(i)=mod((5^(k+z1(i-1))).*r.*((x1(i-1)^2)+y1(i-1)),1);
        r=r+(power(10,-4).*pi.*i)^(1/2);
%   x1(i)=mod((2^13.*u.*(sin(x1(i-1).*pi+y1(i-1).*z1(i-1)))),1);
%   y1(i)=mod((3^13.*(sin(y1(i-1))-u.*x1(i-1).*z1(i-1))),1);
%   z1(i)=mod((5^13.*u.*(x1(i-1)-sin(z1(i-1).*pi+y1(i-1)))),1);
end 
    %d=uint8(mod(floor(x1(501)*10^15),256));%用于密文反馈扩散的与第一个像素异或的值
    %e=uint8(mod(floor(y1(501)*10^15),256));
    x1(1)=x1(500);
    y1(1)=y1(500);
    z1(1)=z1(500);
for j=2:2*M*N+2*M
        x1(i)=mod((2^(k+x1(i-1))).*r.*((y1(i-1)^2)+z1(i-1)),1);
        y1(i)=mod((3^(k+y1(i-1))).*r.*((z1(i-1)^2)+x1(i-1)),1);
        z1(i)=mod((5^(k+z1(i-1))).*r.*((x1(i-1)^2)+y1(i-1)),1);
     
%   x1(j)=mod((2^13.*u.*(sin(x1(j-1).*pi+y1(j-1).*z1(j-1)))),1);
%   y1(j)=mod((3^13.*(sin(y1(j-1))-u.*x1(j-1).*z1(j-1))),1);
%   z1(j)=mod((5^13.*u.*(x1(j-1)-sin(z1(j-1).*pi+y1(j-1)))),1);
  r=r+(power(10,-4).*pi.*j)^(1/2);
end
  F=uint8(mod(floor(x1(1:M*N)*10^15),256));
  D=uint8(mod(floor(y1(1:M*N)*10^15),256));
  E=uint8(mod(floor(z1(1:M*N)*10^15),256));
  F1=uint8(mod(floor(x1(M*N+1:2*M*N)*10^15),256));
  D1=uint8(mod(floor(y1(M*N+1:2*M*N)*10^15),256));
  E1=uint8(mod(floor(z1(M*N+1:2*M*N)*10^15),256));
  F2=uint8(mod(floor(x1(2*M*N+1:2*M*N+M)*10^15),256));
  D2=uint8(mod(floor(y1(2*M*N+1:2*M*N+M)*10^15),256));
  E2=uint8(mod(floor(z1(2*M*N+1:2*M*N+M)*10^15),256));
  G2=uint8(mod(floor(x1(2*M*N+M+1:2*M*N+2*M)*10^15),256));
D=reshape(D,M,N);
F=reshape(F,M,N);
E=reshape(E,M,N);
F1=reshape(F1,M,N);
D1=reshape(D1,M,N);
E1=reshape(E1,M,N);
[DS,D]=sort(D);
[ES,D]=sort(E);
[FS,D]=sort(F);
D=bitxor(DS,D1);
E=bitxor(ES,E1);
F=bitxor(FS,F1);
P=cat(2,D2,E2,F2);
Q=G2;
% row=sort(mod(floor(row1*10^15),256));
% col=sort(mod(floor(G2*10^15),256));
% P=sort(row1);
[PS,P]=sort(P);
P=uint16(P);
%Q=sort(G2);
[QS,Q]=sort(Q);
Q=uint16(Q);
Gs=I(Q,:);
G=Gs(:,P);
D3=G(:,1:M);
E3=G(:,M+1:2*M);
F3=G(:,2*M+1:3*M);
D6=bitxor(D,D3);
E6=bitxor(E,E3);
F6=bitxor(F,F3);
G3=[D6,E6,F6];
S={'E1','49','20','6A','91','13','B4','C1','61','14','59','3D','DB','F4','40','5A','74','FC','8B','5F','7C','F7','4E','07','6C','63','FB','C6','31','FE','FD','15','EA','A7','FF','E7','44','45','2E','94','EE','92','7A','EB','A6','88','02','F5','E6','12','30','9E','2D','00','B3','DD','19','56','F0','96','7F','21','0B','06','A5','37','52','51','7E','5B','72','D5','A3','AB','23','F8','C7','47','9A','36','F6','24','C8','3B','BC','DE','25','D4','D2','81','C5','ED','D1','71','7B','CA','F2','0E','D9','C9','99','97','9F','1E','46','27','D0','DC','09','5D','3E','68','5C','66','AA','E2','A8','62','9B','B2','6F','04','11','DA','55','93','82','0C','53','CE','4B','A0','F9','F3','78','BB','EF','35','7D','57','B8','1D','3A','95','01','98','05','17','10','6B','AC','B1','33','A4','22','38','CC','70','CB','8A','FA','F1','C2','AE','E5','8D','1C','C3','DF','3F','BF','4F','42','5E','BA','26','E8','73','41','16','32','8F','77','60','69','AD','39','28','3C','E0','E4','D6','A9','B6','86','B9','6D','64','65','C4','4D','18','1B','D3','1F','90','8E','9D','A2','D8','43','34','E9','D7','BE','08','54','50','2F','CD','CF','03','B5','0A','AF','8C','E3','0F','85','9C','A1','1A','84','76','B0','4A','4C','6E','89','2A','67','2C','83','29','58','BD','EC','0D','2B','79','48','B7','C0','75','87','80'};
%S={'A7','18','45','93','A4','B8','49','27','71','66','16','0A','33','C9','C6','53','8C','58','11','65','CF','D2','61','DC','5B','57','FE','EC','FA','E1','FF','5A','0E','47','BC','07','E3','0C','8E','9E','78','89','91','4C','90','4B','4D','02','9A','81','2B','D1','44','C8','BD','88','6F','08','7E','35','DE','F0','A6','D5','E4','7A','68','4F','7C','5E','21','A8','6C','EE','B3','ED','99','20','70','51','98','73','6E','4A','1B','06','5C','BF','83','2E','29','7B','B1','25','80','6A','D8','74','F4','F2','13','97','52','19','67','7D','CE','96','A2','55','EA','3D','3A','E5','CA','01','2D','C3','60','B5','F3','23','C5','22','9D','C7','A0','41','C0','FB','59','30','E2','14','BB','1A','5D','69','36','AF','7F','F7','A9','8A','E0','F8','C4','87','00','A3','B2','CB','F1','DB','39','75','AE','37','38','26','A1','76','AD','CD','94','F5','34','9B','1D','FC','04','95','8B','32','40','3E','E9','D3','6D','92','72','AC','12','E8','84','24','9F','6B','50','43','DA','EB','C2','1F','B9','E6','85','D6','0B','AA','9C','B0','2F','31','64','2C','D9','56','AB','4E','3F','03','1C','FD','5F','F6','8D','CC','42','79','54','3C','05','B4','86','BE','E7','1E','A5','DD','46','17','09','48','77','0D','D0','DF','B7','28','2A','0F','15','62','BA','8F','D4','EF','F9','B6','3B','63','10','82','C1','D7'};
%S={'01','27','94','C4','63','1E','0A','57','06','C8','F7','5F','FB','0E','C7','4A','98','49','18','00','20','A0','2F','76','93','0C','CB','FC','A4','AF','60','D3','B6','AC','55','3C','D9','54','DE','A8','26','74','EC','50','EE','B0','3A','11','70','D0','9B','1F','DA','14','C1','7C','90','B9','E8','58','4D','E2','7B','BF','66','7E','82','A6','3B','77','DC','89','CA','4C','F0','CC','15','84','02','97','B4','17','F4','64','59','37','F3','EB','DB','4F','BB','5E','C3','03','6B','8E','7D','D1','A7','EF','CF','B8','B1','FD','CD','2B','F6','99','2A','36','D8','B7','08','4E','39','30','C6','BD','81','71','B2','2D','69','D4','13','DF','61','56','7A','80','6C','5D','FE','40','1C','EA','AD','51','24','95','8F','88','52','0B','41','B3','3F','83','AA','85','A3','05','04','E1','A1','25','FA','1D','E5','AE','53','6A','C9','C0','3D','28','9D','5C','CE','DD','9C','A2','48','6D','86','BC','F9','5A','0D','D2','6E','19','F5','91','8C','44','FF','07','72','D6','46','34','9E','E7','92','9A','35','68','E4','8D','D7','9F','45','16','79','1B','75','8B','47','1A','33','29','43','87','F2','12','A5','F1','2E','31','6F','F8','ED','4B','7F','42','21','C5','BA','2C','67','E3','AB','10','E6','0F','09','C2','73','23','8A','22','96','32','3E','BE','5B','62','38','E9','B5','D5','65','E0','A9','78'};
SS=hex2dec(S);
SS=uint8(SS);
for i=1:M
    for j=1:N
        G3(i,j)=SS(G3(i,j)+1);
   end
end         
%D4=G3(:,1:M);
%E4=G3(:,M+1:2*M);
%F4=G3(:,2*M+1:3*M);
%D5=bitxor(D4,E4);
%E5=bitxor(E4,F4);
%F5=bitxor(F4,D4);
%CCC=[D5,E5,F5];
CCC=G3;
CC(:,:,1)=CCC(:,1:M);
CC(:,:,2)=CCC(:,M+1:2*M);
CC(:,:,3)=CCC(:,2*M+1:3*M);
imwrite(CC,'加密Lena512.bmp');